# 订单系统模块

## 概述

订单系统是电商平台的核心模块，负责管理用户的购物车、订单创建、订单状态管理、支付和物流等完整流程。

## 功能特性

### 1. 购物车管理
- **购物车操作**: 添加商品、更新数量、移除商品、清空购物车
- **库存验证**: 实时检查商品库存和可用性
- **商品快照**: 保存商品信息快照，防止商品信息变更影响购物车
- **数量限制**: 支持最大999件商品数量限制

### 2. 订单管理
- **订单创建**: 从购物车创建订单，自动计算金额
- **订单状态**: 完整的订单状态流转（待付款→已付款→处理中→已发货→已送达→已完成）
- **订单查询**: 支持多条件查询和分页
- **订单统计**: 提供订单数据统计和分析
- **权限控制**: 用户只能操作自己的订单，管理员可操作所有订单

### 3. 支付集成（预留）
- **支付方式**: 支持多种支付方式（支付宝、微信支付等）
- **支付状态**: 支付状态跟踪和管理
- **支付回调**: 支付成功/失败回调处理
- **退款处理**: 订单退款功能

### 4. 物流管理（预留）
- **物流方式**: 支持多种物流方式选择
- **物流跟踪**: 物流单号跟踪和状态更新
- **发货管理**: 发货时间记录和通知
- **签收确认**: 订单签收状态管理

## 数据库设计

### 核心表结构

#### Order（订单表）
- **基础信息**: 订单号、用户ID、订单状态
- **金额信息**: 商品小计、运费、税费、折扣、总金额
- **收货地址**: JSON格式存储收货地址信息
- **支付信息**: 支付方式、支付状态、支付ID、支付时间
- **物流信息**: 物流方式、物流单号、发货时间、签收时间
- **备注信息**: 客户备注、管理员备注

#### OrderItem（订单项表）
- **商品信息**: 商品ID、数量、单价、小计
- **快照信息**: 商品信息快照，防止商品信息变更影响历史订单
- **关联关系**: 关联订单和商品

#### Cart（购物车表）
- **用户关联**: 每个用户一个购物车
- **购物车项**: 通过CartItem关联商品

#### CartItem（购物车项表）
- **商品信息**: 商品ID、数量
- **唯一约束**: 同一购物车中同一商品只能有一条记录

### 状态枚举

#### OrderStatus（订单状态）
- `PENDING`: 待付款
- `PAID`: 已付款
- `PROCESSING`: 处理中
- `SHIPPED`: 已发货
- `DELIVERED`: 已送达
- `COMPLETED`: 已完成
- `CANCELLED`: 已取消
- `REFUNDED`: 已退款

#### PaymentStatus（支付状态）
- `PENDING`: 待支付
- `PAID`: 已支付
- `FAILED`: 支付失败
- `REFUNDED`: 已退款
- `CANCELLED`: 已取消

## API 接口

### 订单管理接口

#### 创建订单
- **路径**: `POST /orders`
- **权限**: 需要登录
- **功能**: 从购物车创建订单，自动计算金额和库存

#### 获取订单列表
- **路径**: `GET /orders`
- **权限**: 需要登录
- **功能**: 分页查询订单列表，支持多条件筛选

#### 获取订单详情
- **路径**: `GET /orders/:id`
- **权限**: 需要登录
- **功能**: 获取订单详细信息，包含订单项和用户信息

#### 更新订单
- **路径**: `PUT /orders/:id`
- **权限**: 需要登录
- **功能**: 更新订单信息（主要用于管理员操作）

#### 取消订单
- **路径**: `PUT /orders/:id/cancel`
- **权限**: 需要登录
- **功能**: 取消订单并恢复库存

#### 删除订单
- **路径**: `DELETE /orders/:id`
- **权限**: 仅管理员
- **功能**: 删除订单（软删除）

#### 获取订单统计
- **路径**: `GET /orders/stats`
- **权限**: 需要登录
- **功能**: 获取订单统计数据

### 购物车管理接口

#### 获取购物车
- **路径**: `GET /cart`
- **权限**: 需要登录
- **功能**: 获取用户购物车信息

#### 添加商品到购物车
- **路径**: `POST /cart/items`
- **权限**: 需要登录
- **功能**: 添加商品到购物车

#### 更新购物车商品数量
- **路径**: `PUT /cart/items/:productId`
- **权限**: 需要登录
- **功能**: 更新购物车中商品数量

#### 从购物车移除商品
- **路径**: `DELETE /cart/items/:productId`
- **权限**: 需要登录
- **功能**: 从购物车移除指定商品

#### 清空购物车
- **路径**: `DELETE /cart/clear`
- **权限**: 需要登录
- **功能**: 清空购物车

#### 获取购物车商品数量
- **路径**: `GET /cart/count`
- **权限**: 需要登录
- **功能**: 获取购物车商品总数量

#### 验证购物车商品可用性
- **路径**: `GET /cart/validate`
- **权限**: 需要登录
- **功能**: 验证购物车中商品的可用性

## 业务逻辑

### 订单创建流程

1. **验证购物车**: 检查购物车中商品是否可用
2. **计算金额**: 计算商品小计、运费、税费、折扣等
3. **检查库存**: 验证商品库存是否充足
4. **生成订单号**: 生成唯一的订单号
5. **创建订单**: 保存订单信息和订单项
6. **更新库存**: 减少商品库存数量
7. **清空购物车**: 清空用户购物车

### 订单状态流转

```
PENDING → PAID → PROCESSING → SHIPPED → DELIVERED → COMPLETED
   ↓         ↓         ↓         ↓         ↓
CANCELLED  CANCELLED  CANCELLED  CANCELLED  CANCELLED
   ↓
REFUNDED
```

### 库存管理

- **下单时**: 减少商品库存
- **取消订单**: 恢复商品库存
- **库存检查**: 创建订单前验证库存充足性

## 安全特性

### 权限控制
- **用户权限**: 用户只能操作自己的订单和购物车
- **管理员权限**: 管理员可以操作所有订单
- **角色验证**: 基于JWT令牌的角色验证

### 数据验证
- **输入验证**: 使用class-validator进行数据验证
- **业务验证**: 库存检查、状态验证等业务规则
- **类型安全**: 使用TypeScript确保类型安全

### 错误处理
- **统一异常**: 使用全局异常过滤器处理错误
- **详细错误信息**: 提供清晰的错误提示
- **日志记录**: 记录重要操作和错误信息

## 扩展性设计

### 支付集成
- **预留接口**: 为支付系统预留接口和字段
- **支付回调**: 支持支付成功/失败回调
- **多种支付方式**: 支持支付宝、微信支付等

### 物流集成
- **物流接口**: 为物流系统预留接口
- **物流跟踪**: 支持物流状态跟踪
- **多物流商**: 支持多个物流服务商

### 消息通知
- **订单通知**: 订单状态变更通知
- **库存预警**: 库存不足预警
- **支付通知**: 支付成功/失败通知

## 性能优化

### 数据库优化
- **索引设计**: 为常用查询字段添加索引
- **分页查询**: 支持分页查询减少数据传输
- **关联查询**: 优化关联查询性能

### 缓存策略
- **购物车缓存**: 购物车数据缓存
- **商品信息缓存**: 商品基础信息缓存
- **订单统计缓存**: 订单统计数据缓存

## 监控和日志

### 操作日志
- **订单操作**: 记录订单创建、更新、取消等操作
- **购物车操作**: 记录购物车添加、删除等操作
- **支付操作**: 记录支付相关操作

### 性能监控
- **响应时间**: 监控API响应时间
- **数据库性能**: 监控数据库查询性能
- **错误率**: 监控系统错误率

## 测试策略

### 单元测试
- **服务层测试**: 测试业务逻辑正确性
- **数据验证测试**: 测试输入验证功能
- **异常处理测试**: 测试异常情况处理

### 集成测试
- **API测试**: 测试API接口功能
- **数据库测试**: 测试数据库操作
- **权限测试**: 测试权限控制功能

### 性能测试
- **并发测试**: 测试高并发情况下的性能
- **压力测试**: 测试系统压力承受能力
- **负载测试**: 测试系统负载能力

## 部署说明

### 环境要求
- **Node.js**: >= 18.0.0
- **PostgreSQL**: >= 13.0
- **Redis**: >= 6.0（可选，用于缓存）

### 配置说明
- **数据库连接**: 配置PostgreSQL连接信息
- **JWT密钥**: 配置JWT签名密钥
- **支付配置**: 配置支付接口信息（预留）
- **物流配置**: 配置物流接口信息（预留）

### 启动命令
```bash
# 安装依赖
npm install

# 数据库迁移
npx prisma migrate deploy

# 启动服务
npm run start:prod
```

## 注意事项

1. **库存管理**: 确保库存操作的原子性，避免超卖
2. **订单号唯一性**: 确保订单号全局唯一
3. **状态一致性**: 确保订单状态流转的一致性
4. **数据备份**: 定期备份订单数据
5. **监控告警**: 设置关键指标监控和告警

## 未来规划

1. **微服务拆分**: 将订单系统拆分为独立的微服务
2. **消息队列**: 引入消息队列处理异步任务
3. **分布式事务**: 实现分布式事务保证数据一致性
4. **实时通知**: 实现实时订单状态通知
5. **数据分析**: 增加订单数据分析和报表功能
