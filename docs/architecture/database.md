# 数据库设计

## 概述

本文档详细描述了万花电商系统的数据库设计，包含产品管理、订单系统、评论系统等核心功能，支持本地存储和CDN双重媒体存储方案。

## 核心功能模块

### 1. 产品管理系统

#### 产品核心表 (Product)
- **完善的产品信息**：支持长描述、简短描述、原价折扣显示
- **库存管理**：库存数量、最小库存预警
- **物流信息**：重量、尺寸信息（为物流系统预留）
- **商品编码**：SKU、条形码支持
- **SEO优化**：独立的SEO标题、描述、关键词
- **分类管理**：支持多级产品分类

#### 产品媒体系统 (ProductMedia)
- **双存储支持**：
  - 本地存储：`local_path`, `filename`
  - CDN存储：`cdn_url`, `cdn_key`
- **媒体类型**：图片、视频全支持
- **完整元数据**：文件大小、MIME类型、尺寸、时长
- **缩略图支持**：视频自动生成缩略图
- **分类管理**：主图、画廊、详情图分类

#### 产品分类 (ProductCategory)
- **多级分类**：支持无限级分类结构
- **SEO友好**：slug URL支持
- **排序管理**：自定义排序权重

### 2. 订单管理系统

#### 订单核心表 (Order)
- **完整订单流程**：从待付款到已完成的全状态管理
- **金额计算**：商品小计、运费、税费、折扣的详细计算
- **地址管理**：JSON格式存储收货地址
- **支付接口预留**：
  - 支付方式、支付状态
  - 第三方支付ID、支付时间
- **物流接口预留**：
  - 物流方式、物流单号
  - 发货时间、签收时间
- **备注系统**：客户备注、管理员备注

#### 订单项表 (OrderItem)
- **价格快照**：记录下单时的价格，避免后续价格变动影响
- **产品快照**：JSON格式保存商品信息快照

#### 购物车系统 (Cart/CartItem)
- **用户购物车**：每用户一个购物车
- **防重复**：同一商品在购物车中只能有一条记录

### 3. 评论系统

#### 评论核心表 (ProductReview)
- **购买验证**：必须关联订单，确保用户购买过才能评论
- **评分系统**：1-5星评分
- **回复功能**：支持多级回复结构
- **审核机制**：待审核、已通过、已拒绝状态
- **有用性统计**：有用数统计

#### 评论媒体系统 (ReviewMedia)
- **媒体限制**：
  - 图片：最大5MB
  - 视频：最大50MB，最长60秒
- **双存储支持**：本地存储 + CDN存储
- **缩略图**：视频自动生成缩略图
- **数量限制**：每条评论最多上传指定数量的媒体文件

### 4. 用户管理系统

#### 用户核心表 (User)
- **完整用户信息**：姓名、电话、头像、生日、性别
- **账户状态**：激活状态、验证状态、最后登录时间
- **角色权限**：用户、员工、管理员三级权限

#### 用户地址表 (UserAddress)
- **多地址支持**：用户可保存多个收货地址
- **默认地址**：支持设置默认收货地址
- **完整地址信息**：国家、省市区、详细地址、邮编

### 5. 认证系统

#### 邮箱验证表 (EmailVerification)
- **验证码管理**：存储邮箱验证码
- **过期机制**：验证码有效期控制
- **类型区分**：注册验证、密码重置等

#### 刷新令牌表 (RefreshToken)
- **Token管理**：存储Refresh Token
- **设备绑定**：Token与设备关联
- **撤销机制**：支持Token撤销

#### 用户设备表 (UserDevice)
- **设备管理**：记录用户设备信息
- **信任机制**：支持受信任设备
- **指纹识别**：设备指纹记录

#### 登录尝试表 (LoginAttempt)
- **安全记录**：记录所有登录尝试
- **防暴力破解**：基于IP和邮箱的限制
- **异常检测**：识别异常登录行为

## 技术特性

### 1. 媒体存储策略

#### 本地存储
- **优势**：成本低、完全控制、数据安全
- **适用场景**：初期运营、小规模应用
- **存储路径**：`uploads/products/`, `uploads/reviews/`
- **文件命名**：UUID + 原始扩展名

#### CDN存储
- **优势**：全球加速、高可用、自动缩放
- **适用场景**：大规模应用、全球用户
- **支持服务**：Cloudflare R2、AWS S3、阿里云OSS等
- **迁移策略**：新旧数据并存，逐步迁移

### 2. 数据库优化

#### 索引策略
- **主要索引**：
  - 产品：分类、状态、创建时间
  - 订单：用户、状态、订单号、创建时间
  - 评论：产品、用户、订单、状态、创建时间
  - 媒体：关联ID、类型、存储类型

#### 软删除
- **支持表**：Product, ProductReview
- **实现方式**：`deleted_at` 字段
- **查询过滤**：业务层自动过滤已删除记录

### 3. 业务规则

#### 评论规则
1. **购买验证**：必须有已完成的订单才能评论
2. **媒体限制**：
   - 图片：JPEG/PNG/WebP，最大5MB
   - 视频：MP4/WebM，最大50MB，最长60秒
   - 数量：每条评论最多9张图片或3个视频
3. **审核机制**：新评论默认待审核状态

#### 订单规则
1. **状态流转**：严格按照业务流程进行状态变更
2. **库存扣减**：下单时扣减库存，取消时恢复
3. **价格快照**：订单生成时保存商品价格快照

#### 媒体处理规则
1. **自动压缩**：图片自动压缩优化
2. **缩略图生成**：视频自动生成缩略图
3. **格式转换**：统一转换为Web友好格式
4. **CDN同步**：本地文件自动同步到CDN

## 扩展性设计

### 1. 支付系统接入
- **预留字段**：payment_method, payment_status, payment_id
- **支持方式**：微信支付、支付宝、PayPal、Stripe等
- **回调处理**：支付状态异步更新机制

### 2. 物流系统接入
- **预留字段**：shipping_method, tracking_number, shipped_at
- **支持方式**：顺丰、圆通、DHL、FedEx等
- **状态同步**：物流状态自动同步更新

### 3. 营销系统
- **优惠券**：可扩展优惠券表
- **促销活动**：可扩展促销规则表
- **会员系统**：可扩展会员等级表

## 安全考虑

### 1. 数据安全
- **敏感信息加密**：密码使用bcrypt加密
- **文件上传验证**：严格的文件类型和大小验证
- **SQL注入防护**：使用Prisma ORM防止SQL注入

### 2. 业务安全
- **权限控制**：基于角色的访问控制
- **操作日志**：关键操作记录审计日志
- **数据备份**：定期数据库备份策略

## 性能优化

### 1. 查询优化
- **合理索引**：基于查询模式创建索引
- **分页查询**：大数据量列表使用分页
- **缓存策略**：热点数据Redis缓存

### 2. 存储优化
- **媒体CDN**：静态资源CDN加速
- **数据归档**：历史数据定期归档
- **读写分离**：主从数据库读写分离

## 部署建议

### 1. 开发环境
- **本地存储**：使用本地文件存储
- **SQLite/PostgreSQL**：轻量级数据库
- **Mock服务**：支付、物流Mock服务

### 2. 生产环境
- **CDN存储**：Cloudflare R2或AWS S3
- **PostgreSQL集群**：主从复制、读写分离
- **Redis缓存**：会话、缓存管理
- **监控告警**：数据库、应用监控

## 总结

本数据库设计充分考虑了电商系统的复杂性和扩展性需求，提供了：

1. **完整的产品管理**：支持多媒体、多分类、SEO优化
2. **灵活的订单系统**：预留支付、物流接口，支持完整业务流程
3. **强大的评论系统**：购买验证、媒体上传、审核机制
4. **双存储策略**：本地存储与CDN并存，支持平滑迁移
5. **良好的扩展性**：预留接口，支持后续功能扩展

该设计既满足了当前的业务需求，又为未来的发展留下了充足的扩展空间。

---

**相关文档**:
- [系统概览](./overview.md)
- [API设计规范](./api-standards.md)
- [认证系统模块](../modules/auth.md)

